variables:
    TXT_E: "\e[31m"
    TXT_S: "\e[35m"
    TXT_CLEAR: "\e[0m"

.unit_test: &unit_test
  script:
    - scripts/bootstrap.sh
    - scripts/build_ci.sh
    - scripts/run_unittests.sh
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /WIP$/
      when: never
  artifacts:
    paths:
      - build_dev/*_junit.txt
    reports:
      junit: build_dev/*_junit.txt

.merge_request: &merge_request
  tags:
    - ubuntu20.04
  script:
    - scripts/bootstrap.sh
    - scripts/build_ci_merge.sh
    - scripts/valgrind_unittests.sh 
  artifacts:
    paths:
      - public
      - build_dev/*_junit.txt
      - build_dev/valgrind-out.txt
    reports:
      junit: build_dev/*_junit.txt

unit_tests:ubuntu20_04:
  <<: *unit_test 
  tags:
    - ubuntu20.04
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'

unit_tests:ubuntu18_04:
  <<: *unit_test 
  tags:
    - ubuntu18.04
  rules:
    - when: always

unit_tests:rasppi4:
  <<: *unit_test 
  tags:
    - rasppi4
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

merge_request:
  <<: *merge_request
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

.webpage: &webpage
  tags:
    - ubuntu20.04
  script:
    - scripts/bootstrap.sh
    - scripts/build_webpage.sh
  artifacts:
    paths:
    - public

test_webpage:
  <<: *webpage
  except:
    - master

webpage:
  <<: *webpage
  only:
    - master

pages:
  <<: *merge_request
  stage: deploy
  needs: ["webpage"]
  only:
  - master
  